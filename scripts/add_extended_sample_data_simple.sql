-- Add more historical data for 2025-01-02 to support Support & Resistance strategy testing
-- This extends the existing data from 11:09 AM to 4:00 PM (market close)

-- Generate extended AAPL data with realistic price action around support/resistance levels
-- AAPL: Support around 150.5, Resistance around 155.5

INSERT INTO ohlcv_data (symbol, timestamp, open, high, low, close, volume, timeframe)
SELECT 
    'AAPL' as symbol,
    '2025-01-02 11:10:00+00'::timestamp + (n || ' minutes')::interval as timestamp,
    CASE 
        WHEN n = 0 THEN 152.0
        ELSE lag_close
    END as open,
    CASE 
        WHEN n = 0 THEN 152.0
        ELSE lag_close
    END + 
    CASE 
        -- Create realistic price movements with support/resistance behavior
        WHEN (lag_close <= 150.7 AND random() < 0.7) THEN random() * 1.2 + 0.3  -- Bounce off support
        WHEN (lag_close >= 155.3 AND random() < 0.6) THEN -(random() * 1.0 + 0.2) -- Reject at resistance
        WHEN random() < 0.5 THEN random() * 0.8 - 0.4  -- Random movement
        ELSE random() * 0.6 - 0.3
    END as high,
    CASE 
        WHEN n = 0 THEN 152.0
        ELSE lag_close
    END + 
    CASE 
        WHEN (lag_close <= 150.7 AND random() < 0.7) THEN -(random() * 0.5 + 0.1)  -- Support test
        WHEN (lag_close >= 155.3 AND random() < 0.6) THEN -(random() * 1.2 + 0.3) -- Resistance rejection
        WHEN random() < 0.5 THEN -(random() * 0.8) + 0.2
        ELSE -(random() * 0.6) + 0.1
    END as low,
    -- Close price with support/resistance logic
    CASE 
        WHEN n = 0 THEN 152.0
        WHEN (lag_close <= 150.7) THEN 150.7 + random() * 1.0  -- Bounce from support
        WHEN (lag_close >= 155.3 AND random() < 0.8) THEN 155.3 - random() * 0.8  -- Reject at resistance
        WHEN (lag_close >= 155.3 AND random() >= 0.8) THEN 155.3 + random() * 1.5  -- Breakout (20% chance)
        ELSE lag_close + (random() - 0.5) * 1.0
    END as close,
    (1000000 + random() * 2000000)::bigint as volume,
    '1m' as timeframe
FROM (
    SELECT 
        n,
        LAG(
            CASE 
                WHEN n = 0 THEN 152.0
                WHEN (LAG(close_price, 1, 152.0) OVER (ORDER BY n) <= 150.7) THEN 150.7 + random() * 1.0
                WHEN (LAG(close_price, 1, 152.0) OVER (ORDER BY n) >= 155.3 AND random() < 0.8) THEN 155.3 - random() * 0.8
                WHEN (LAG(close_price, 1, 152.0) OVER (ORDER BY n) >= 155.3 AND random() >= 0.8) THEN 155.3 + random() * 1.5
                ELSE LAG(close_price, 1, 152.0) OVER (ORDER BY n) + (random() - 0.5) * 1.0
            END, 1, 152.0
        ) OVER (ORDER BY n) as lag_close
    FROM (
        SELECT 
            generate_series(0, 289) as n,  -- 290 minutes (11:10 AM to 4:00 PM)
            152.0 as close_price
    ) base
) series_data;

-- Simpler approach: Insert pre-calculated data with clear support/resistance patterns
INSERT INTO ohlcv_data (symbol, timestamp, open, high, low, close, volume, timeframe) VALUES
-- AAPL data with clear support at 150.5 and resistance at 155.5
('AAPL', '2025-01-02 11:10:00+00', 152.0, 152.5, 151.8, 152.2, 1500000, '1m'),
('AAPL', '2025-01-02 11:11:00+00', 152.2, 152.8, 152.0, 152.6, 1200000, '1m'),
('AAPL', '2025-01-02 11:12:00+00', 152.6, 153.2, 152.4, 153.0, 1100000, '1m'),
('AAPL', '2025-01-02 11:13:00+00', 153.0, 153.5, 152.7, 153.3, 1300000, '1m'),
('AAPL', '2025-01-02 11:14:00+00', 153.3, 154.0, 153.1, 153.8, 1400000, '1m'),
('AAPL', '2025-01-02 11:15:00+00', 153.8, 154.5, 153.6, 154.2, 1600000, '1m'),
('AAPL', '2025-01-02 11:16:00+00', 154.2, 154.8, 154.0, 154.6, 1800000, '1m'),
('AAPL', '2025-01-02 11:17:00+00', 154.6, 155.2, 154.4, 155.0, 2000000, '1m'),
('AAPL', '2025-01-02 11:18:00+00', 155.0, 155.6, 154.8, 155.4, 2200000, '1m'),
('AAPL', '2025-01-02 11:19:00+00', 155.4, 155.7, 155.2, 155.5, 2500000, '1m'), -- Touch resistance
('AAPL', '2025-01-02 11:20:00+00', 155.5, 155.6, 154.8, 155.0, 2800000, '1m'), -- Rejection
('AAPL', '2025-01-02 11:21:00+00', 155.0, 155.2, 154.3, 154.5, 2100000, '1m'),
('AAPL', '2025-01-02 11:22:00+00', 154.5, 154.8, 153.9, 154.1, 1900000, '1m'),
('AAPL', '2025-01-02 11:23:00+00', 154.1, 154.4, 153.6, 153.8, 1700000, '1m'),
('AAPL', '2025-01-02 11:24:00+00', 153.8, 154.1, 153.2, 153.4, 1500000, '1m'),
('AAPL', '2025-01-02 11:25:00+00', 153.4, 153.7, 152.8, 153.0, 1400000, '1m'),
('AAPL', '2025-01-02 11:26:00+00', 153.0, 153.3, 152.4, 152.6, 1300000, '1m'),
('AAPL', '2025-01-02 11:27:00+00', 152.6, 152.9, 152.0, 152.2, 1200000, '1m'),
('AAPL', '2025-01-02 11:28:00+00', 152.2, 152.5, 151.6, 151.8, 1100000, '1m'),
('AAPL', '2025-01-02 11:29:00+00', 151.8, 152.1, 151.2, 151.4, 1000000, '1m'),
('AAPL', '2025-01-02 11:30:00+00', 151.4, 151.7, 150.8, 151.0, 1200000, '1m'),
('AAPL', '2025-01-02 11:31:00+00', 151.0, 151.3, 150.4, 150.6, 1500000, '1m'),
('AAPL', '2025-01-02 11:32:00+00', 150.6, 150.9, 150.3, 150.5, 2000000, '1m'), -- Touch support
('AAPL', '2025-01-02 11:33:00+00', 150.5, 151.2, 150.4, 150.9, 2500000, '1m'), -- Bounce
('AAPL', '2025-01-02 11:34:00+00', 150.9, 151.6, 150.7, 151.3, 2200000, '1m'),
('AAPL', '2025-01-02 11:35:00+00', 151.3, 152.0, 151.1, 151.7, 1900000, '1m'),
('AAPL', '2025-01-02 11:36:00+00', 151.7, 152.4, 151.5, 152.1, 1700000, '1m'),
('AAPL', '2025-01-02 11:37:00+00', 152.1, 152.8, 151.9, 152.5, 1500000, '1m'),
('AAPL', '2025-01-02 11:38:00+00', 152.5, 153.2, 152.3, 152.9, 1400000, '1m'),
('AAPL', '2025-01-02 11:39:00+00', 152.9, 153.6, 152.7, 153.3, 1300000, '1m'),
('AAPL', '2025-01-02 11:40:00+00', 153.3, 154.0, 153.1, 153.7, 1400000, '1m'),
('AAPL', '2025-01-02 11:41:00+00', 153.7, 154.4, 153.5, 154.1, 1500000, '1m'),
('AAPL', '2025-01-02 11:42:00+00', 154.1, 154.8, 153.9, 154.5, 1600000, '1m'),
('AAPL', '2025-01-02 11:43:00+00', 154.5, 155.2, 154.3, 154.9, 1800000, '1m'),
('AAPL', '2025-01-02 11:44:00+00', 154.9, 155.6, 154.7, 155.3, 2000000, '1m'),
('AAPL', '2025-01-02 11:45:00+00', 155.3, 155.8, 155.1, 155.5, 2200000, '1m'), -- Touch resistance again
('AAPL', '2025-01-02 11:46:00+00', 155.5, 155.7, 154.9, 155.1, 2500000, '1m'), -- Rejection
('AAPL', '2025-01-02 11:47:00+00', 155.1, 155.4, 154.6, 154.8, 2100000, '1m'),
('AAPL', '2025-01-02 11:48:00+00', 154.8, 155.1, 154.3, 154.5, 1900000, '1m'),
('AAPL', '2025-01-02 11:49:00+00', 154.5, 154.8, 154.0, 154.2, 1700000, '1m'),
('AAPL', '2025-01-02 11:50:00+00', 154.2, 154.5, 153.7, 153.9, 1500000, '1m'),
-- Continue pattern with eventual breakout
('AAPL', '2025-01-02 11:51:00+00', 153.9, 154.2, 153.4, 153.6, 1400000, '1m'),
('AAPL', '2025-01-02 11:52:00+00', 153.6, 153.9, 153.1, 153.3, 1300000, '1m'),
('AAPL', '2025-01-02 11:53:00+00', 153.3, 153.6, 152.8, 153.0, 1200000, '1m'),
('AAPL', '2025-01-02 11:54:00+00', 153.0, 153.3, 152.5, 152.7, 1100000, '1m'),
('AAPL', '2025-01-02 11:55:00+00', 152.7, 153.0, 152.2, 152.4, 1200000, '1m'),
('AAPL', '2025-01-02 11:56:00+00', 152.4, 152.7, 151.9, 152.1, 1300000, '1m'),
('AAPL', '2025-01-02 11:57:00+00', 152.1, 152.4, 151.6, 151.8, 1400000, '1m'),
('AAPL', '2025-01-02 11:58:00+00', 151.8, 152.1, 151.3, 151.5, 1500000, '1m'),
('AAPL', '2025-01-02 11:59:00+00', 151.5, 151.8, 151.0, 151.2, 1600000, '1m'),
('AAPL', '2025-01-02 12:00:00+00', 151.2, 151.5, 150.7, 150.9, 1800000, '1m'),
('AAPL', '2025-01-02 12:01:00+00', 150.9, 151.2, 150.4, 150.6, 2000000, '1m'),
('AAPL', '2025-01-02 12:02:00+00', 150.6, 150.9, 150.3, 150.5, 2200000, '1m'), -- Support test
('AAPL', '2025-01-02 12:03:00+00', 150.5, 151.3, 150.4, 151.0, 2800000, '1m'), -- Strong bounce
('AAPL', '2025-01-02 12:04:00+00', 151.0, 151.8, 150.8, 151.5, 2500000, '1m'),
('AAPL', '2025-01-02 12:05:00+00', 151.5, 152.3, 151.3, 152.0, 2200000, '1m');

-- Add similar pattern for TSLA with different levels
INSERT INTO ohlcv_data (symbol, timestamp, open, high, low, close, volume, timeframe) VALUES
-- TSLA data with support at 395 and resistance at 410
('TSLA', '2025-01-02 11:10:00+00', 401.0, 402.5, 400.5, 402.0, 1200000, '1m'),
('TSLA', '2025-01-02 11:11:00+00', 402.0, 403.8, 401.7, 403.5, 1100000, '1m'),
('TSLA', '2025-01-02 11:12:00+00', 403.5, 405.2, 403.2, 404.8, 1000000, '1m'),
('TSLA', '2025-01-02 11:13:00+00', 404.8, 406.5, 404.5, 406.2, 1300000, '1m'),
('TSLA', '2025-01-02 11:14:00+00', 406.2, 408.0, 405.9, 407.5, 1400000, '1m'),
('TSLA', '2025-01-02 11:15:00+00', 407.5, 409.2, 407.2, 408.8, 1600000, '1m'),
('TSLA', '2025-01-02 11:16:00+00', 408.8, 410.5, 408.5, 409.8, 1800000, '1m'),
('TSLA', '2025-01-02 11:17:00+00', 409.8, 411.0, 409.5, 410.2, 2000000, '1m'),
('TSLA', '2025-01-02 11:18:00+00', 410.2, 411.2, 409.8, 410.5, 2200000, '1m'), -- Touch resistance
('TSLA', '2025-01-02 11:19:00+00', 410.5, 410.8, 408.5, 409.0, 2500000, '1m'), -- Rejection
('TSLA', '2025-01-02 11:20:00+00', 409.0, 409.5, 407.2, 407.8, 2100000, '1m'),
('TSLA', '2025-01-02 11:21:00+00', 407.8, 408.3, 406.0, 406.5, 1900000, '1m'),
('TSLA', '2025-01-02 11:22:00+00', 406.5, 407.0, 404.8, 405.2, 1700000, '1m'),
('TSLA', '2025-01-02 11:23:00+00', 405.2, 405.7, 403.5, 404.0, 1500000, '1m'),
('TSLA', '2025-01-02 11:24:00+00', 404.0, 404.5, 402.2, 402.8, 1400000, '1m'),
('TSLA', '2025-01-02 11:25:00+00', 402.8, 403.3, 401.0, 401.5, 1300000, '1m'),
('TSLA', '2025-01-02 11:26:00+00', 401.5, 402.0, 399.8, 400.2, 1200000, '1m'),
('TSLA', '2025-01-02 11:27:00+00', 400.2, 400.7, 398.5, 399.0, 1100000, '1m'),
('TSLA', '2025-01-02 11:28:00+00', 399.0, 399.5, 397.2, 397.8, 1000000, '1m'),
('TSLA', '2025-01-02 11:29:00+00', 397.8, 398.3, 396.0, 396.5, 1200000, '1m'),
('TSLA', '2025-01-02 11:30:00+00', 396.5, 397.0, 394.8, 395.2, 1500000, '1m'),
('TSLA', '2025-01-02 11:31:00+00', 395.2, 395.7, 394.5, 395.0, 2000000, '1m'), -- Touch support
('TSLA', '2025-01-02 11:32:00+00', 395.0, 396.8, 394.8, 396.5, 2500000, '1m'), -- Bounce
('TSLA', '2025-01-02 11:33:00+00', 396.5, 398.2, 396.2, 397.8, 2200000, '1m'),
('TSLA', '2025-01-02 11:34:00+00', 397.8, 399.5, 397.5, 399.0, 1900000, '1m'),
('TSLA', '2025-01-02 11:35:00+00', 399.0, 400.7, 398.7, 400.2, 1700000, '1m');

-- Show the updated counts
SELECT 'Extended AAPL data:' as info, COUNT(*) as count, MIN(timestamp), MAX(timestamp) 
FROM ohlcv_data WHERE symbol = 'AAPL' AND DATE(timestamp) = '2025-01-02';

SELECT 'Extended TSLA data:' as info, COUNT(*) as count, MIN(timestamp), MAX(timestamp) 
FROM ohlcv_data WHERE symbol = 'TSLA' AND DATE(timestamp) = '2025-01-02';
